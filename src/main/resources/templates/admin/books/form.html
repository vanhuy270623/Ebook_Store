<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
	<th:block th:replace="~{admin/layout/head :: head}"></th:block>
	<title>Quản lý sách - Ebook Store</title>
	<style>
		.image-preview {
			max-width: 200px;
			max-height: 300px;
			margin-top: 10px;
			display: none;
		}
		.required-field::after {
			content: " *";
			color: red;
		}
	</style>
</head>
<body class="hold-transition skin-blue sidebar-mini">
<div class="wrapper">
	<!-- Header -->
	<div th:replace="~{admin/layout/header :: header}"></div>

	<!-- Sidebar -->
	<div th:replace="~{admin/layout/sidebar :: sidebar}"></div>

	<!-- Content Wrapper -->
	<div class="content-wrapper">
		<!-- Content Header -->
		<section class="content-header">
			<h1>
				<span th:text="${isEdit != null && isEdit} ? 'Chỉnh sửa sách' : 'Thêm sách mới'">Quản lý sách</span>
				<small th:if="${isEdit && bookEntity != null}" th:text="${bookEntity.title}">Tên sách</small>
				<small th:if="${!isEdit || bookEntity == null}">Nhập thông tin sách</small>
			</h1>
			<ol class="breadcrumb">
				<li><a th:href="@{/admin/dashboard}"><i class="fa fa-dashboard"></i> Dashboard</a></li>
				<li><a th:href="@{/admin/books}">Quản lý sách</a></li>
				<li class="active" th:text="${isEdit != null && isEdit} ? 'Chỉnh sửa' : 'Thêm mới'">Form</li>
			</ol>
		</section>

		<!-- Main content -->
		<section class="content">
			<!-- Flash Messages -->
			<div class="row" th:if="${success} or ${error} or ${warning}">
				<div class="col-md-12">
					<div class="alert alert-success alert-dismissible" th:if="${success}">
						<button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
						<h4><i class="icon fa fa-check"></i> Thành công!</h4>
						<span th:text="${success}"></span>
					</div>
					<div class="alert alert-danger alert-dismissible" th:if="${error}">
						<button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
						<h4><i class="icon fa fa-ban"></i> Lỗi!</h4>
						<span th:text="${error}"></span>
					</div>
					<div class="alert alert-warning alert-dismissible" th:if="${warning}">
						<button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
						<h4><i class="icon fa fa-warning"></i> Cảnh báo!</h4>
						<span th:text="${warning}"></span>
					</div>
				</div>
			</div>

			<!-- Form -->
			<form th:action="@{${isEdit ? '/admin/books/update' : '/admin/books/create'}}"
				  th:object="${bookRequest}"
				  method="post"
				  enctype="multipart/form-data">

				<!-- Hidden bookId for edit mode -->
				<input type="hidden" th:if="${isEdit != null && isEdit}" th:field="*{bookId}"/>

				<div class="row">
					<!-- Left Column -->
					<div class="col-md-8">
						<div class="box box-primary">
							<div class="box-header with-border">
								<h3 class="box-title">Thông tin cơ bản</h3>
							</div>
							<div class="box-body">
								<!-- Title -->
								<div class="form-group" th:classappend="${#fields.hasErrors('title')} ? 'has-error'">
									<label for="title" class="required-field">Tên sách</label>
									<input type="text" class="form-control" id="title" th:field="*{title}"
										   placeholder="Nhập tên sách" maxlength="500" required>
									<span class="help-block" th:if="${#fields.hasErrors('title')}" th:errors="*{title}"></span>
								</div>

								<!-- Description -->
								<div class="form-group" th:classappend="${#fields.hasErrors('description')} ? 'has-error'">
									<label for="description">Mô tả</label>
									<textarea class="form-control" id="description" th:field="*{description}" rows="5"
											  placeholder="Nhập mô tả về sách" maxlength="5000"></textarea>
									<span class="help-block" th:if="${#fields.hasErrors('description')}" th:errors="*{description}"></span>
								</div>

								<!-- Category -->
								<div class="form-group" th:classappend="${#fields.hasErrors('bookCategoryId')} ? 'has-error'">
									<label for="bookCategoryId" class="required-field">Thể loại</label>
									<select class="form-control" id="bookCategoryId" th:field="*{bookCategoryId}" required>
										<option value="">-- Chọn thể loại --</option>
										<option th:each="category : ${categories}"
												th:value="${category.bookCategoryId}"
												th:text="${category.categoryName}"></option>
									</select>
									<span class="help-block" th:if="${#fields.hasErrors('bookCategoryId')}" th:errors="*{bookCategoryId}"></span>
								</div>

								<!-- Authors -->
								<div class="form-group" th:classappend="${#fields.hasErrors('authorIds')} ? 'has-error'">
									<label for="authorIds" class="required-field">Tác giả</label>
									<select class="form-control select2" id="authorIds" th:field="*{authorIds}" multiple="multiple"
											data-placeholder="Chọn tác giả" style="width: 100%;" required>
										<option th:each="author : ${authors}"
												th:value="${author.authorId}"
												th:text="${author.name}"
												th:selected="${isEdit && currentAuthorIds != null && currentAuthorIds.contains(author.authorId)}"></option>
									</select>
									<span class="help-block" th:if="${#fields.hasErrors('authorIds')}" th:errors="*{authorIds}"></span>
								</div>

								<!-- Publisher -->
								<div class="form-group" th:classappend="${#fields.hasErrors('publisher')} ? 'has-error'">
									<label for="publisher">Nhà xuất bản</label>
									<input type="text" class="form-control" id="publisher" th:field="*{publisher}"
										   placeholder="Nhập tên nhà xuất bản" maxlength="255">
									<span class="help-block" th:if="${#fields.hasErrors('publisher')}" th:errors="*{publisher}"></span>
								</div>

								<!-- Publication Year and Language -->
								<div class="row">
									<div class="col-md-6">
										<div class="form-group" th:classappend="${#fields.hasErrors('publicationYear')} ? 'has-error'">
											<label for="publicationYear">Năm xuất bản</label>
											<input type="number" class="form-control" id="publicationYear" th:field="*{publicationYear}"
												   placeholder="2024" min="1000" max="9999">
											<span class="help-block" th:if="${#fields.hasErrors('publicationYear')}" th:errors="*{publicationYear}"></span>
										</div>
									</div>
									<div class="col-md-6">
										<div class="form-group" th:classappend="${#fields.hasErrors('language')} ? 'has-error'">
											<label for="language">Ngôn ngữ</label>
											<select class="form-control" id="language" th:field="*{language}">
												<option value="">-- Chọn ngôn ngữ --</option>
												<option value="vi">Tiếng Việt</option>
												<option value="en">English</option>
												<option value="fr">Français</option>
												<option value="zh">中文</option>
												<option value="ja">日本語</option>
											</select>
											<span class="help-block" th:if="${#fields.hasErrors('language')}" th:errors="*{language}"></span>
										</div>
									</div>
								</div>

								<!-- Pages and ISBN -->
								<div class="row">
									<div class="col-md-6">
										<div class="form-group" th:classappend="${#fields.hasErrors('pages')} ? 'has-error'">
											<label for="pages">Số trang</label>
											<input type="number" class="form-control" id="pages" th:field="*{pages}"
												   placeholder="Nhập số trang" min="1">
											<span class="help-block" th:if="${#fields.hasErrors('pages')}" th:errors="*{pages}"></span>
										</div>
									</div>
									<div class="col-md-6">
										<div class="form-group" th:classappend="${#fields.hasErrors('isbn')} ? 'has-error'">
											<label for="isbn">ISBN</label>
											<input type="text" class="form-control" id="isbn" th:field="*{isbn}"
												   placeholder="Nhập mã ISBN" maxlength="20">
											<span class="help-block" th:if="${#fields.hasErrors('isbn')}" th:errors="*{isbn}"></span>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>

					<!-- Right Column -->
					<div class="col-md-4">
						<!-- Cover Image -->
						<div class="box box-primary">
							<div class="box-header with-border">
								<h3 class="box-title">Ảnh bìa sách</h3>
							</div>
							<div class="box-body">
								<div class="form-group">
									<!-- Current image (Edit mode) -->
									<div th:if="${isEdit && bookRequest.coverImageUrl != null && !bookRequest.coverImageUrl.isEmpty()}" class="mb-2">
										<label>Ảnh hiện tại:</label><br>
										<img th:src="@{${bookRequest.coverImageUrl}}" class="img-thumbnail"
											 style="max-width: 200px; max-height: 300px;"
											 th:alt="${bookEntity != null ? bookEntity.title : 'Cover image'}">
									</div>

									<!-- Upload new image -->
									<label th:text="${isEdit ? 'Thay đổi ảnh bìa' : 'Tải lên ảnh bìa'}">Tải lên ảnh bìa</label>
									<input type="file" name="coverImage" id="coverImage"
										   accept="image/*" class="form-control">
									<img id="imagePreview" src="" alt="Preview ảnh bìa" class="image-preview img-thumbnail" style="display: none;">
								</div>

								<!-- Hidden field for existing cover URL -->
								<input type="hidden" th:field="*{coverImageUrl}">
							</div>
						</div>

						<!-- Price and Access Type -->
						<div class="box box-primary">
							<div class="box-header with-border">
								<h3 class="box-title">Giá và quyền truy cập</h3>
							</div>
							<div class="box-body">
								<!-- Price -->
								<div class="form-group" th:classappend="${#fields.hasErrors('price')} ? 'has-error'">
									<label for="price" class="required-field">Giá bán (VNĐ)</label>
									<input type="number" class="form-control" id="price" th:field="*{price}"
										   placeholder="0" min="0" step="1000" required>
									<small class="text-muted">Nhập 0 nếu sách miễn phí</small>
									<span class="help-block" th:if="${#fields.hasErrors('price')}" th:errors="*{price}"></span>
								</div>

								<!-- Access Type -->
								<div class="form-group" th:classappend="${#fields.hasErrors('accessType')} ? 'has-error'">
									<label for="accessType" class="required-field">Loại truy cập</label>
									<select class="form-control" id="accessType" th:field="*{accessType}" required>
										<option value="">-- Chọn loại truy cập --</option>
										<option th:each="type : ${accessTypes}"
												th:value="${type}"
												th:text="${type}"></option>
									</select>
									<span class="help-block" th:if="${#fields.hasErrors('accessType')}" th:errors="*{accessType}"></span>
								</div>

								<!-- Is Downloadable -->
								<div class="form-group">
									<div class="checkbox">
										<label>
											<input type="checkbox" th:field="*{isDownloadable}">
											Cho phép tải xuống
										</label>
									</div>
								</div>

								<!-- Statistics (Edit mode only) -->
								<div class="form-group" th:if="${isEdit && bookEntity != null}">
									<label>Thống kê</label>
									<p class="text-muted">
										<i class="fa fa-star text-yellow"></i>
										Đánh giá: <strong th:text="${bookEntity.averageRating}">0</strong>/5
										(<span th:text="${bookEntity.totalReviews}">0</span> đánh giá)<br>
										<i class="fa fa-eye"></i>
										Lượt xem: <strong th:text="${bookEntity.viewCount}">0</strong>
									</p>
								</div>
							</div>
						</div>

						<!-- Action Buttons -->
						<div class="box box-solid">
							<div class="box-body">
								<button type="submit" class="btn btn-primary btn-block">
									<i class="fa fa-save"></i>
									<span th:text="${isEdit ? 'Cập nhật sách' : 'Lưu sách'}">Lưu sách</span>
								</button>
								<a th:href="@{/admin/books}" class="btn btn-default btn-block">
									<i class="fa fa-times"></i> Hủy bỏ
								</a>
							</div>
						</div>
					</div>
				</div>
			</form>
		</section>
	</div>

	<!-- Footer -->
	<div th:replace="~{admin/layout/footer :: footer}"></div>
</div>

<!-- Scripts -->
<th:block th:replace="~{admin/layout/scripts :: scripts}"></th:block>
<!-- Select2 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

<script>
$(document).ready(function() {
	// Initialize Select2
	$('.select2').select2({
		placeholder: "Chọn tác giả",
		allowClear: true
	});

	// Image preview
	$('#coverImage').change(function() {
		const file = this.files[0];
		if (file) {
			const reader = new FileReader();
			reader.onload = function(e) {
				$('#imagePreview').attr('src', e.target.result).show();
			}
			reader.readAsDataURL(file);
		}
	});
});
</script>
</body>
</html>

