<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<th:block th:replace="~{admin/layout/head :: head}"></th:block>
	<!-- DataTables CSS -->
	<link rel="stylesheet" href="/admin_template/plugins/datatables/dataTables.bootstrap.min.css">
</head>
<body class="hold-transition skin-blue sidebar-mini">
<div class="wrapper">
	<!-- Header -->
	<div th:replace="~{admin/layout/header :: header}"></div>

	<!-- Sidebar -->
	<div th:replace="~{admin/layout/sidebar :: sidebar}"></div>

	<!-- Content Wrapper -->
	<div class="content-wrapper">
		<!-- Content Header -->
		<section class="content-header">
			<h1>
				Quản lý sách
				<small>Danh sách tất cả sách trong hệ thống</small>
			</h1>
			<ol class="breadcrumb">
				<li><a th:href="@{/admin/dashboard}"><i class="fa fa-dashboard"></i> Dashboard</a></li>
				<li class="active">Quản lý sách</li>
			</ol>
		</section>

		<!-- Main content -->
		<section class="content">
			<div class="row">
				<div class="col-xs-12">
					<div class="box box-solid">
						<div class="box-body">
							<form method="get" action="/admin/books" class="form-inline">
								<div class="form-group">
									<input type="text" name="search" class="form-control"
										   placeholder="Tìm kiếm..."
										   th:value="${search}" style="width: 300px;">
								</div>
								<button type="submit" class="btn btn-primary"><i class="fa fa-search"></i></button>
								<a th:href="@{/admin/books}" class="btn btn-default"><i class="fa fa-refresh"></i></a>
								<a th:href="@{/admin/books/add}" class="btn btn-success pull-right"><i class="fa fa-plus"></i>Thêm sách mới</a>
							</form>
						</div>
					</div>
				</div>
			</div>

			<div class="row">
				<div class="col-xs-12">
					<div class="box">
						<div class="box-header">
							<h3 class="box-title">Danh sách sách (<span th:text="${totalBooks}">0</span> cuốn)</h3>
						</div>

						<div class="box-body">
							<table id="booksTable" class="table table-bordered table-striped">
								<thead>
									<tr>
										<th>Ảnh bìa</th>
										<th>Tên sách</th>
										<th>Thể loại</th>
										<th>Giá</th>
										<th>Loại truy cập</th>
										<th>Đánh giá</th>
										<th>Lượt xem</th>
										<th>Ngày tạo</th>
										<th>Thao tác</th>
									</tr>
								</thead>
								<tbody>
									<tr th:each="book : ${books}">
										<td>
											<img th:src="${book.coverImageUrl}" th:alt="${book.title}"
												 class="img-thumbnail" style="width: 50px; height: 70px; object-fit: cover;"
												 onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2250%22 height=%2270%22%3E%3Crect fill=%22%23ddd%22 width=%2250%22 height=%2270%22/%3E%3Ctext fill=%22%23999%22 font-family=%22sans-serif%22 font-size=%228%22 font-weight=%22bold%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22%3ENo Image%3C/text%3E%3C/svg%3E';">
										</td>
										<td>
											<strong th:text="${book.title}">Tên sách</strong><br>
											<small class="text-muted" th:text="${book.isbn}">ISBN</small>
										</td>
										<td>
											<span class="label label-info" th:text="${book.bookCategory?.categoryName ?: 'Chưa phân loại'}">Thể loại</span>
										</td>
										<td>
											<span th:if="${book.price == 0}" class="label label-success">Miễn phí</span>
											<span th:if="${book.price > 0}" th:text="${#numbers.formatDecimal(book.price, 0, 'COMMA', 0, 'POINT')} + 'đ'" class="text-primary">0đ</span>
										</td>
										<td>
											<span th:switch="${book.accessType}">
												<span th:case="'FREE'" class="label label-success">Miễn phí</span>
												<span th:case="'PURCHASE'" class="label label-primary">Mua</span>
												<span th:case="'SUBSCRIPTION'" class="label label-warning">Gói đăng ký</span>
												<span th:case="'BOTH'" class="label label-info">Cả hai</span>
											</span>
										</td>
										<td>
											<i class="fa fa-star text-yellow"></i>
											<span th:text="${#numbers.formatDecimal(book.averageRating, 1, 2)}">0.0</span>
											<small class="text-muted">(<span th:text="${book.totalReviews}">0</span>)</small>
										</td>
										<td>
											<span th:text="${#numbers.formatInteger(book.viewCount, 0, 'COMMA')}">0</span>
										</td>
										<td>
											<span th:text="${#temporals.format(book.createdAt, 'dd/MM/yyyy')}">01/01/2024</span>
										</td>
										<td>
											<div class="btn-group">
												<a th:href="@{/admin/books/view/{id}(id=${book.bookId})}"
												   class="btn btn-sm btn-info" title="Xem chi tiết">
													<i class="fa fa-search"></i>
												</a>
											<a th:href="@{/admin/books/edit/{id}(id=${book.bookId})}"
											   class="btn btn-sm btn-warning" title="Chỉnh sửa">
												<i class="fa fa-pencil"></i>
											</a>
											<button class="btn btn-sm btn-success btn-manage-assets" title="Quản lý file"
													th:data-book-id="${book.bookId}">
												<i class="fa fa-file-pdf-o"></i>
											</button>
											<button class="btn btn-sm btn-danger btn-delete-book" title="Xóa sách"
													th:data-book-id="${book.bookId}">
												<i class="fa fa-trash-o"></i>
											</button>
											</div>
										</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</section>
	</div>

	<!-- Footer -->
	<div th:replace="~{admin/layout/footer :: footer}"></div>
</div>

<!-- Scripts -->
<th:block th:replace="~{admin/layout/scripts :: scripts}"></th:block>
<!-- DataTables -->
<script src="/admin_template/plugins/datatables/jquery.dataTables.min.js"></script>
<script src="/admin_template/plugins/datatables/dataTables.bootstrap.min.js"></script>
<script>
$(document).ready(function() {
	$('#booksTable').DataTable({
		"paging": true,
		"lengthChange": true,
		"searching": false,
		"ordering": true,
		"info": true,
		"autoWidth": false,
		"pageLength": 25,
		"language": {
			"url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Vietnamese.json"
		}
	});

	// Add event listeners for manage assets buttons
	$(document).on('click', '.btn-manage-assets', function() {
	var bookId = $(this).data('book-id');
	deleteBook(bookId);
});
});

function manageBookAssets(bookId) {
	// TODO: Implement book assets management
	alert('Chức năng quản lý file sách sẽ được phát triển sau.\nBook ID: ' + bookId);
}

function deleteBook(bookId) {
	if(confirm('Bạn có chắc chắn muốn xóa sách này?\nHành động này không thể hoàn tác!')) {
		// Get CSRF token from cookie
		var token = getCookie('XSRF-TOKEN');

		$.ajax({
			url: '/admin/books/delete/' + bookId,
			type: 'POST',
			xhrFields: {
				withCredentials: true
			},
			headers: {
				'X-XSRF-TOKEN': token,
				'X-Requested-With': 'XMLHttpRequest'
			},
			success: function(response, textStatus, xhr) {
				// Check if response is HTML (login page redirect)
				if(typeof response === 'string' && response.includes('<!DOCTYPE html>')) {
					alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại!');
					window.location.href = '/auth/login';
					return;
				}

				// Parse response if string
				if(typeof response === 'string') {
					try {
						response = JSON.parse(response);
					} catch(e) {
						alert('Lỗi: Không thể xử lý phản hồi từ server');
						return;
					}
				}

				if(response && response.success) {
					alert(response.message);
					location.reload();
				} else {
					alert('Lỗi: ' + (response && response.message ? response.message : 'Có lỗi xảy ra khi xóa sách'));
				}
			},
			error: function(xhr, status, error) {
				// Check for 401 Unauthorized (session expired)
				if(xhr.status === 401) {
					var message = 'Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại!';
					if(xhr.responseJSON && xhr.responseJSON.message) {
						message = xhr.responseJSON.message;
					}
					alert(message);
					window.location.href = '/auth/login';
					return;
				}

				// Check if redirected to login page (HTML response)
				if(xhr.responseText && xhr.responseText.includes('<!DOCTYPE html>')) {
					alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại!');
					window.location.href = '/auth/login';
					return;
				}

				var errorMessage = 'Có lỗi xảy ra khi xóa sách!';
				if(xhr.responseJSON && xhr.responseJSON.message) {
					errorMessage = xhr.responseJSON.message;
				} else if(xhr.status === 403) {
					errorMessage = 'Lỗi bảo mật: Không có quyền thực hiện thao tác này!';
				}
				alert(errorMessage);
			}
		});
	}
}

// Helper function to get cookie value
function getCookie(name) {
	var value = "; " + document.cookie;
	var parts = value.split("; " + name + "=");
	if (parts.length == 2) return parts.pop().split(";").shift();
	return null;
}
</script>
</body>
</html>
