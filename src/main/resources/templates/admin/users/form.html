<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
	<th:block th:replace="~{admin/layout/head :: head}"></th:block>
	<title>Quản lý người dùng - Ebook Store</title>
</head>
<body class="hold-transition skin-blue sidebar-mini">
<div class="wrapper">
	<!-- Header -->
	<div th:replace="~{admin/layout/header :: header}"></div>

	<!-- Sidebar -->
	<div th:replace="~{admin/layout/sidebar :: sidebar}"></div>

	<!-- Content Wrapper -->
	<div class="content-wrapper">
		<!-- Content Header -->
		<section class="content-header">
			<h1>
				<span th:text="${isEdit != null && isEdit} ? 'Chỉnh sửa người dùng' : 'Thêm người dùng mới'">Quản lý người dùng</span>
				<small th:text="${isEdit != null && isEdit} ? 'Cập nhật thông tin người dùng' : 'Tạo tài khoản mới'">Form</small>
			</h1>
			<ol class="breadcrumb">
				<li><a th:href="@{/admin/dashboard}"><i class="fa fa-dashboard"></i> Dashboard</a></li>
				<li><a th:href="@{/admin/users}">Quản lý người dùng</a></li>
				<li class="active" th:text="${isEdit != null && isEdit} ? 'Chỉnh sửa' : 'Thêm mới'">Form</li>
			</ol>
		</section>

		<!-- Main content -->
		<section class="content">
			<!-- Flash Messages -->
			<div class="row" th:if="${success} or ${error}">
				<div class="col-md-12">
					<div class="alert alert-success alert-dismissible" th:if="${success}">
						<button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
						<i class="icon fa fa-check"></i> <span th:text="${success}"></span>
					</div>
					<div class="alert alert-danger alert-dismissible" th:if="${error}">
						<button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
						<i class="icon fa fa-ban"></i> <span th:text="${error}"></span>
					</div>
				</div>
			</div>

			<!-- Form -->
			<div class="row">
				<div class="col-md-8 col-md-offset-2">
					<div class="box box-primary">
						<div class="box-header with-border">
							<h3 class="box-title">
								<i class="fa fa-user"></i>
								<span th:text="${isEdit != null && isEdit} ? 'Thông tin người dùng' : 'Thông tin người dùng mới'">Form</span>
							</h3>
						</div>

						<form th:action="@{/admin/users/save}" th:object="${user}" method="post">
							<div class="box-body">
								<!-- Hidden userId field for edit mode -->
								<input type="hidden" th:field="*{userId}"/>

								<!-- Username - Only show input for new user, readonly for edit -->
								<div class="form-group" th:if="${isEdit == null || !isEdit}">
									<label for="username">Tên đăng nhập <span class="text-danger">*</span></label>
									<input type="text" class="form-control" id="username" th:field="*{username}"
										   placeholder="Nhập tên đăng nhập" required
										   pattern="[a-zA-Z0-9_]{3,50}"
										   title="Tên đăng nhập chỉ chứa chữ cái, số và dấu gạch dưới, từ 3-50 ký tự">
									<p class="help-block">Tên đăng nhập sẽ được tự động sinh nếu để trống</p>
								</div>

								<!-- Show username as readonly in edit mode -->
								<div class="form-group" th:if="${isEdit != null && isEdit}">
									<label>Tên đăng nhập</label>
									<input type="text" class="form-control" th:value="*{username}" readonly>
									<p class="help-block text-muted">Tên đăng nhập không thể thay đổi</p>
								</div>

								<!-- Full Name -->
								<div class="form-group">
									<label for="fullName">Họ và tên</label>
									<input type="text" class="form-control" id="fullName" th:field="*{fullName}"
										   placeholder="Nhập họ và tên đầy đủ">
								</div>

								<!-- Email -->
								<div class="form-group">
									<label for="email">Email <span class="text-danger">*</span></label>
									<input type="email" class="form-control" id="email" th:field="*{email}"
										   placeholder="example@email.com" required>
								</div>

								<!-- Phone -->
								<div class="form-group">
									<label for="phone">Số điện thoại</label>
									<input type="tel" class="form-control" id="phone" th:field="*{phone}"
										   placeholder="0123456789"
										   pattern="[0-9]{10,11}">
								</div>

								<!-- Password -->
								<div class="form-group">
									<label for="password">
										Mật khẩu
										<span th:if="${isEdit == null || !isEdit}" class="text-danger">*</span>
									</label>
									<input type="password" class="form-control" id="password" name="password"
										   placeholder="Nhập mật khẩu (tối thiểu 6 ký tự)"
										   th:required="${isEdit == null || !isEdit}"
										   minlength="6">
									<p class="help-block" th:if="${isEdit == null || !isEdit}">
										Mật khẩu mặc định là <strong>123456</strong> nếu để trống
									</p>
									<p class="help-block" th:if="${isEdit != null && isEdit}">
										Để trống nếu không muốn thay đổi mật khẩu
									</p>
								</div>

								<!-- Role -->
								<div class="form-group">
									<label for="roleId">Vai trò <span class="text-danger">*</span></label>
									<select name="roleId" id="roleId" class="form-control" required>
										<option value="">-- Chọn vai trò --</option>
										<option th:each="role : ${roles}"
												th:value="${role.roleId}"
												th:text="${role.roleName}"
												th:selected="${user.role != null && user.role.roleId == role.roleId}"
												th:disabled="${role.roleName.name() == 'ADMIN' && (canManageAdmin == null || !canManageAdmin)}">
										</option>
									</select>
									<p class="help-block">
										<i class="fa fa-info-circle"></i>
										Chỉ admin_1 mới có thể tạo/quản lý tài khoản admin
									</p>
								</div>

								<!-- Avatar URL -->
								<div class="form-group">
									<label for="avatarUrl">URL Avatar</label>
									<input type="url" class="form-control" id="avatarUrl" th:field="*{avatarUrl}"
										   placeholder="https://example.com/avatar.jpg">
									<p class="help-block">
										<i class="fa fa-info-circle"></i>
										Nhập đường dẫn URL của ảnh đại diện (nếu có)
									</p>
								</div>

								<!-- Reading Mode (optional) -->
								<div class="form-group">
									<label for="preferredReadingMode">Chế độ đọc ưa thích</label>
									<select class="form-control" id="preferredReadingMode" th:field="*{preferredReadingMode}">
										<option value="AUTO">Tự động</option>
										<option value="LIGHT">Sáng</option>
										<option value="DARK">Tối</option>
									</select>
								</div>

								<!-- Active Status -->
								<div class="form-group">
									<div class="checkbox">
										<label>
											<input type="checkbox" th:field="*{isActive}" checked>
											<strong>Kích hoạt tài khoản</strong>
										</label>
									</div>
									<p class="help-block text-muted">
										Tài khoản bị vô hiệu hóa sẽ không thể đăng nhập vào hệ thống
									</p>
								</div>

								<!-- Verified Status (only show in edit mode) -->
								<div class="form-group" th:if="${isEdit != null && isEdit}">
									<div class="checkbox">
										<label>
											<input type="checkbox" th:field="*{isVerified}">
											<strong>Đã xác thực email</strong>
										</label>
									</div>
									<p class="help-block text-muted">
										Đánh dấu email đã được xác thực thủ công
									</p>
								</div>
							</div>

							<!-- Form Footer -->
							<div class="box-footer">
								<button type="submit" class="btn btn-primary btn-lg">
									<i class="fa fa-save"></i>
									<span th:text="${isEdit != null && isEdit} ? 'Cập nhật người dùng' : 'Thêm người dùng mới'">Lưu</span>
								</button>
								<a th:href="@{/admin/users}" class="btn btn-default btn-lg">
									<i class="fa fa-arrow-left"></i> Quay lại danh sách
								</a>
								<button type="reset" class="btn btn-warning btn-lg pull-right">
									<i class="fa fa-refresh"></i> Đặt lại
								</button>
							</div>
						</form>
					</div>

					<!-- Help Box -->
					<div class="box box-info">
						<div class="box-header with-border">
							<h3 class="box-title"><i class="fa fa-question-circle"></i> Hướng dẫn</h3>
						</div>
						<div class="box-body">
							<ul>
								<li>Các trường có dấu <span class="text-danger">*</span> là bắt buộc</li>
								<li>Tên đăng nhập chỉ chứa chữ cái, số và dấu gạch dưới</li>
								<li>Mật khẩu phải có ít nhất 6 ký tự</li>
								<li>Email phải là định dạng hợp lệ</li>
								<li>User ID sẽ được tự động sinh theo format: <code>user_normal_XX</code></li>
								<li th:if="${isEdit == null || !isEdit}">Mật khẩu mặc định là <strong>123456</strong> nếu không nhập</li>
							</ul>
						</div>
					</div>
				</div>
			</div>
		</section>
	</div>

	<!-- Footer -->
	<div th:replace="~{admin/layout/footer :: footer}"></div>
</div>

<!-- Scripts -->
<th:block th:replace="~{admin/layout/scripts :: scripts}"></th:block>

<!-- Custom validation script -->
<script>
$(document).ready(function() {
	// Form validation
	$('form').on('submit', function(e) {
		var isEdit = $('input[name="userId"]').val() !== '';
		var password = $('#password').val();

		// Validate password for new user
		if (!isEdit && password && password.length < 6) {
			alert('Mật khẩu phải có ít nhất 6 ký tự!');
			e.preventDefault();
			return false;
		}

		// Show loading
		$('button[type="submit"]').prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Đang xử lý...');
	});

	// Preview avatar
	$('#avatarUrl').on('blur', function() {
		var url = $(this).val();
		if (url) {
			// Could add avatar preview here
		}
	});
});
</script>
</body>
</html>