<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<th:block th:replace="~{admin/layout/head :: head}"></th:block>
	<link rel="stylesheet" href="/admin_template/plugins/datatables/dataTables.bootstrap.css">
</head>
<body class="hold-transition skin-blue sidebar-mini">
<div class="wrapper">
	<div th:replace="~{admin/layout/header :: header}"></div>

	<div th:replace="~{admin/layout/sidebar :: sidebar}"></div>

	<div class="content-wrapper">
		<section class="content-header">
			<h1>
				Quản lý người dùng
				<small>Danh sách tất cả người dùng trong hệ thống</small>
			</h1>
			<ol class="breadcrumb">
				<li><a th:href="@{/admin/dashboard}"><i class="fa fa-dashboard"></i> Dashboard</a></li>
				<li class="active">Quản lý người dùng</li>
			</ol>
		</section>

		<section class="content">
			<div class="row" th:if="${success} or ${error}">
				<div class="col-xs-12">
					<div class="alert alert-success alert-dismissible" th:if="${success}">
						<button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
						<i class="icon fa fa-check"></i> <span th:text="${success}"></span>
					</div>
					<div class="alert alert-danger alert-dismissible" th:if="${error}">
						<button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
						<i class="icon fa fa-ban"></i> <span th:text="${error}"></span>
					</div>
				</div>
			</div>

			<div class="row">
				<div class="col-xs-12">
					<div class="box box-solid">
						<div class="box-body">
							<form method="get" action="/admin/users" class="form-inline">
								<div class="form-group">
									<input type="text" name="search" class="form-control"
										   placeholder="Tìm kiếm..."
										   th:value="${search}" style="width: 300px;">
								</div>
								<button type="submit" class="btn btn-primary"><i class="fa fa-search"></i> Tìm kiếm</button>
								<a th:href="@{/admin/users}" class="btn btn-default"><i class="fa fa-refresh"></i> Làm mới</a>
								<a th:href="@{/admin/users/add}" class="btn btn-success pull-right"><i class="fa fa-plus"></i> Thêm người dùng mới</a>
							</form>
						</div>
					</div>
				</div>
			</div>

			<div class="row">
				<div class="col-xs-12">
					<div class="box">
						<div class="box-header">
							<h3 class="box-title">Danh sách người dùng</h3>
						</div>

						<div class="box-body">
							<table id="usersTable" class="table table-bordered table-striped">
								<thead>
								<tr>
									<th>Avatar</th>
									<th>Thông tin</th>
									<th>Email & Trạng thái</th>
									<th>Vai trò</th>
									<th>Ngày tạo</th>
									<th>Thao tác</th>
								</tr>
								</thead>
								<tbody>
								<tr th:if="${users == null || users.isEmpty()}">
									<td colspan="6" class="text-center" style="padding: 30px;">
										<i class="fa fa-users" style="font-size: 48px; color: #ccc; margin-bottom: 10px;"></i>
										<h4 style="color: #999; margin: 10px 0;">Không tìm thấy người dùng</h4>
										<p style="color: #bbb;" th:if="${search != null && !search.isEmpty()}">
											Không có kết quả cho từ khóa: "<strong th:text="${search}"></strong>"
										</p>
									</td>
								</tr>
								<tr th:each="user : ${users}">
									<td>
										<img th:src="${user.avatarUrl != null && !user.avatarUrl.isEmpty() ? user.avatarUrl : '/admin_template/images/user-default.png'}"
											 class="img-circle" style="width: 40px; height: 40px; object-fit: cover;">
									</td>

									<td>
										<strong th:text="${user.fullName ?: user.username}">Name</strong><br>
										<small class="text-muted">@<span th:text="${user.username}">user</span></small>
									</td>

									<td>
										<div th:text="${user.email}">email</div>
										<span th:if="${user.isActive}" class="label label-success">Hoạt động</span>
										<span th:if="${!user.isActive}" class="label label-danger">Đã khóa</span>
									</td>

									<td>
                                        <span th:if="${user.role != null}"
											  th:text="${user.role.roleName}"
											  th:class="${user.role.roleName.name() == 'ADMIN' ? 'label label-danger' : 'label label-primary'}">
                                        </span>
									</td>

									<td th:text="${#temporals.format(user.createdAt, 'dd/MM/yyyy')}">Date</td>

									<td>
										<a th:href="@{/admin/users/view/{id}(id=${user.userId})}"
										   class="btn btn-sm btn-info" title="Xem">
											<i class="fa fa-eye"></i>
										</a>

										<a th:href="@{/admin/users/edit/{id}(id=${user.userId})}"
										   class="btn btn-sm btn-primary" title="Sửa">
											<i class="fa fa-pencil"></i>
										</a>

										<form th:action="@{/admin/users/toggle-status/{id}(id=${user.userId})}"
											  method="post" style="display: inline-block;">
											<button type="submit" class="btn btn-sm"
													th:classappend="${user.isActive} ? 'btn-warning' : 'btn-success'"
													th:title="${user.isActive} ? 'Khóa tài khoản' : 'Kích hoạt'"
													onclick="return confirm('Bạn có chắc muốn thay đổi trạng thái tài khoản này?')">
												<i class="fa" th:classappend="${user.isActive} ? 'fa-lock' : 'fa-unlock'"></i>
											</button>
										</form>

										<form th:if="${user.role != null && user.role.roleName.name() != 'ADMIN'}"
											  th:action="@{/admin/users/delete/{id}(id=${user.userId})}"
											  method="post" style="display: inline-block;">
											<button type="submit" class="btn btn-sm btn-danger" title="Xóa"
													th:data-confirm-message="|Bạn có chắc muốn xóa user ${user.username}?|"
													onclick="return confirm(this.getAttribute('data-confirm-message'))">
												<i class="fa fa-trash-o"></i>
											</button>
										</form>
									</td>
								</tr>
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</section>
	</div>

	<div th:replace="~{admin/layout/footer :: footer}"></div>
</div>

<th:block th:replace="~{admin/layout/scripts :: scripts}"></th:block>
<script src="/admin_template/plugins/datatables/jquery.dataTables.min.js"></script>
<script src="/admin_template/plugins/datatables/dataTables.bootstrap.min.js"></script>
<script>
	// Chỉ giữ lại mỗi script khởi tạo DataTable, không còn logic xử lý nút bấm
	$(document).ready(function() {
		$('#usersTable').DataTable({
			"language": { "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Vietnamese.json" }
		});
	});
</script>
</body>
</html>