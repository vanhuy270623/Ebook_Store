<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<th:block th:replace="~{admin/layout/head :: head}"></th:block>
	<style>
		/* Timeline styling improvements */
		.timeline > li > .timeline-item {
			box-shadow: 0 1px 3px rgba(0,0,0,0.12);
			border-radius: 3px;
			margin-top: 0;
			background: #fff;
			color: #444;
			margin-left: 60px;
			margin-right: 15px;
			padding: 10px;
			position: relative;
		}

		.timeline > li > .timeline-item > .timeline-header {
			margin: 0;
			color: #555;
			border-bottom: 1px solid #f4f4f4;
			padding: 5px 0;
			font-size: 15px;
			line-height: 1.1;
		}

		.timeline > li > .timeline-item > .timeline-header.bg-red {
			color: #fff;
			background: #dd4b39;
			margin: -10px -10px 10px -10px;
		}

		.timeline > li > .timeline-item > .time {
			color: #999;
			float: right;
			font-size: 12px;
		}

		.timeline > li > .timeline-item > .timeline-body {
			margin-top: 10px;
		}

		.timeline > li > .fa,
		.timeline > li > .glyphicon,
		.timeline > li > .ion {
			width: 40px;
			height: 40px;
			font-size: 18px;
			line-height: 40px;
			position: absolute;
			color: #666;
			background: #d2d6de;
			border-radius: 50%;
			text-align: center;
			left: 18px;
			top: 0;
		}

		.timeline > li.time-label > span {
			font-weight: 600;
			padding: 5px 10px;
			display: inline-block;
			background-color: #fff;
			border-radius: 4px;
			box-shadow: 0 1px 3px rgba(0,0,0,0.2);
		}

		.timeline > li.time-label > span.bg-red {
			background-color: #dd4b39;
			color: #fff;
		}

		.timeline > li.time-label > span.bg-blue {
			background-color: #0073b7;
			color: #fff;
		}

		.timeline > li.time-label > span.bg-green {
			background-color: #00a65a;
			color: #fff;
		}

		/* Status badges in timeline */
		.timeline-body .label {
			margin-right: 5px;
			font-size: 11px;
			padding: 4px 8px;
		}

		.timeline-body p {
			margin: 5px 0;
		}

		.timeline-body code {
			background: #f4f4f4;
			padding: 2px 6px;
			border-radius: 3px;
			color: #d73925;
			font-size: 12px;
		}
	</style>
</head>
<body class="hold-transition skin-blue sidebar-mini">
<div class="wrapper">
	<div th:replace="~{admin/layout/header :: header}"></div>

	<div th:replace="~{admin/layout/sidebar :: sidebar}"></div>

	<div class="content-wrapper">
		<section class="content-header">
			<h1>
				Chi tiết người dùng
				<small th:text="${user?.fullName ?: user?.username}">Tên người dùng</small>
			</h1>
			<ol class="breadcrumb">
				<li><a th:href="@{/admin/dashboard}"><i class="fa fa-tachometer"></i> Dashboard</a></li>
				<li><a th:href="@{/admin/users}">Quản lý người dùng</a></li>
				<li class="active">Chi tiết</li>
			</ol>
		</section>

		<section class="content-header">
			<div class="row">
				<div class="col-xs-12">
					<a th:href="@{/admin/users}" class="btn btn-default">
						<i class="fa fa-arrow-left"></i> Quay lại danh sách
					</a>
					<a th:href="@{/admin/users/edit/{id}(id=${user?.userId})}" class="btn btn-warning" th:if="${user}">
						<i class="fa fa-pencil"></i> Chỉnh sửa
					</a>
				</div>
			</div>
		</section>

		<section class="content">
			<div class="row" th:if="${success} or ${error}">
				<div class="col-md-12">
					<div class="alert alert-success alert-dismissible" th:if="${success}">
						<button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
						<i class="icon fa fa-check"></i> <span th:text="${success}"></span>
					</div>
					<div class="alert alert-danger alert-dismissible" th:if="${error}">
						<button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
						<i class="icon fa fa-ban"></i> <span th:text="${error}"></span>
					</div>
				</div>
			</div>

			<div class="row" th:if="${user}">
				<div class="col-md-4">
					<div class="box box-primary">
						<div class="box-header with-border">
							<h3 class="box-title">Thông tin cá nhân</h3>
						</div>
						<div class="box-body box-profile">
							<img class="profile-user-img img-responsive img-circle"
								 th:src="${user.avatarUrl != null && !user.avatarUrl.isEmpty() ? user.avatarUrl : '/admin_template/images/user-default.png'}"
								 th:alt="${user.fullName ?: user.username}"
								 style="width:100px; height:100px; object-fit:cover;">

							<h3 class="profile-username text-center" th:text="${user.fullName ?: user.username}">Tên người dùng</h3>

							<p class="text-muted text-center">
								<span th:if="${roleName == 'ADMIN'}" class="label label-danger">
									<i class="fa fa-shield"></i> Administrator
								</span>
								<span th:if="${roleName == 'USER'}" class="label label-primary">
									<i class="fa fa-user"></i> Người dùng
								</span>
								<span th:if="${roleName == null}" class="label label-default">
									<i class="fa fa-question"></i> Chưa có vai trò
								</span>
							</p>

							<ul class="list-group list-group-unbordered">
								<li class="list-group-item">
									<b><i class="fa fa-id-card"></i> User ID</b>
									<span class="pull-right text-muted" th:text="${user.userId}">user_id</span>
								</li>
								<li class="list-group-item">
									<b><i class="fa fa-user-circle"></i> Username</b>
									<span class="pull-right" th:text="${user.username}">username</span>
								</li>
								<li class="list-group-item">
									<b><i class="fa fa-envelope"></i> Email</b>
									<span class="pull-right" th:text="${user.email}">email@example.com</span>
								</li>
								<li class="list-group-item">
									<b><i class="fa fa-phone"></i> Số điện thoại</b>
									<span class="pull-right" th:text="${user.phone ?: 'Chưa cập nhật'}">Chưa cập nhật</span>
								</li>
								<li class="list-group-item">
									<b><i class="fa fa-book"></i> Chế độ đọc</b>
									<span class="pull-right">
										<span th:if="${user.preferredReadingMode != null}" th:text="${user.preferredReadingMode}">AUTO</span>
										<span th:if="${user.preferredReadingMode == null}" class="text-muted">AUTO</span>
									</span>
								</li>
								<li class="list-group-item">
									<b><i class="fa fa-calendar"></i> Ngày đăng ký</b>
									<span class="pull-right">
										<span th:if="${user.createdAt != null}" th:text="${#temporals.format(user.createdAt, 'dd/MM/yyyy HH:mm')}">01/01/2024</span>
										<span th:if="${user.createdAt == null}" class="text-muted">Không xác định</span>
									</span>
								</li>
								<li class="list-group-item">
									<b><i class="fa fa-clock-o"></i> Lần cuối đăng nhập</b>
									<span class="pull-right">
										<span th:if="${user.lastLogin != null}" th:text="${#temporals.format(user.lastLogin, 'dd/MM/yyyy HH:mm')}">Never</span>
										<span th:if="${user.lastLogin == null}" class="text-muted">Chưa đăng nhập</span>
									</span>
								</li>
								<!-- Thông tin xóa mềm -->
								<li class="list-group-item" th:if="${user.deletedAt != null}" style="background-color: #f2dede;">
									<b><i class="fa fa-trash-o"></i> Trạng thái</b>
									<span class="pull-right">
										<span class="label label-danger">
											<i class="fa fa-trash"></i> ĐÃ XÓA
										</span>
									</span>
								</li>
								<li class="list-group-item" th:if="${user.deletedAt != null}" style="background-color: #f2dede;">
									<b><i class="fa fa-calendar-times-o"></i> Thời gian xóa</b>
									<span class="pull-right text-danger" th:text="${#temporals.format(user.deletedAt, 'dd/MM/yyyy HH:mm')}">
										01/01/2024 10:00
									</span>
								</li>
							</ul>

							<div class="row">
								<div class="col-sm-6">
									<div class="text-center">
										<span th:if="${user.isActive}" class="label label-success" style="font-size: 12px;">
											<i class="fa fa-check-circle"></i> Đang hoạt động
										</span>
										<span th:if="${!user.isActive}" class="label label-danger" style="font-size: 12px;">
											<i class="fa fa-times-circle"></i> Đã bị khóa
										</span>
									</div>
								</div>
								<div class="col-sm-6">
									<div class="text-center">
										<span th:if="${user.isVerified}" class="label label-info" style="font-size: 12px;">
											<i class="fa fa-certificate"></i> Đã xác thực
										</span>
										<span th:if="${!user.isVerified}" class="label label-warning" style="font-size: 12px;">
											<i class="fa fa-exclamation-triangle"></i> Chưa xác thực
										</span>
									</div>
								</div>
							</div>

							<div style="margin-top: 20px;">
								<!-- Nếu user đã bị xóa, hiển thị nút khôi phục -->
								<div th:if="${user.deletedAt != null}" class="alert alert-danger" style="margin-bottom: 10px;">
									<i class="fa fa-exclamation-triangle"></i>
									<strong>Người dùng này đã bị xóa!</strong><br>
									<small>Dữ liệu vẫn được lưu trữ và có thể khôi phục.</small>
								</div>

								<th:block th:if="${user.deletedAt != null}">
									<!-- Nút khôi phục cho user đã xóa -->
									<form th:action="@{/admin/users/restore/{id}(id=${user.userId})}"
										  method="post">
										<button type="submit" class="btn btn-success btn-block"
												onclick="return confirm('Bạn có chắc muốn khôi phục người dùng này?')">
											<i class="fa fa-undo"></i> Khôi phục người dùng
										</button>
									</form>
								</th:block>

								<th:block th:if="${user.deletedAt == null}">
									<!-- Các nút thông thường cho user chưa xóa -->
									<a th:href="@{/admin/users/edit/{id}(id=${user.userId})}" class="btn btn-warning btn-block">
										<i class="fa fa-pencil"></i> Chỉnh sửa thông tin
									</a>

									<!-- Only show toggle status button if user is not user_admin_01 -->
									<form th:if="${user.userId != 'user_admin_01'}"
										  th:action="@{/admin/users/toggle-status/{id}(id=${user.userId})}"
										  method="post"
										  style="margin-top: 5px;">
										<button type="submit" class="btn btn-block"
												th:classappend="${user.isActive} ? 'btn-danger' : 'btn-success'"
												onclick="return confirm('Bạn có chắc chắn muốn thay đổi trạng thái tài khoản này?')">
											<i class="fa" th:classappend="${user.isActive} ? 'fa-lock' : 'fa-unlock'"></i>
											<span th:text="${user.isActive} ? 'Khóa tài khoản' : 'Kích hoạt tài khoản'">Action</span>
										</button>
									</form>
								</th:block>
							</div>
						</div>
					</div>
				</div>

				<div class="col-md-8">
					<div class="nav-tabs-custom">
						<ul class="nav nav-tabs">
							<li class="active"><a href="#activity" data-toggle="tab">Hoạt động</a></li>
							<li><a href="#orders" data-toggle="tab">Đơn hàng</a></li>
						</ul>
						<div class="tab-content">
							<div class="active tab-pane" id="activity">
								<div class="box-body">
									<h4><i class="fa fa-history"></i> Lịch sử hoạt động</h4>
									<div th:if="${user.createdAt != null}">
										<ul class="timeline timeline-inverse" style="margin-left: 0;">

											<!-- Sự kiện XÓA TÀI KHOẢN (nếu có) -->
											<th:block th:if="${user.deletedAt != null}">
												<li class="time-label">
													<span class="bg-red" th:text="${#temporals.format(user.deletedAt, 'dd/MM/yyyy')}">Ngày xóa</span>
												</li>
												<li>
													<i class="fa fa-trash bg-red"></i>
													<div class="timeline-item">
														<span class="time"><i class="fa fa-clock-o"></i>
															<span th:text="${#temporals.format(user.deletedAt, 'HH:mm')}">10:00</span>
														</span>
														<h3 class="timeline-header bg-red" style="padding: 5px 10px; border-radius: 3px;">
															<strong>Tài khoản đã bị xóa</strong>
														</h3>
														<div class="timeline-body">
															<div class="alert alert-danger" style="margin-bottom: 0;">
																<i class="fa fa-exclamation-triangle"></i>
																<strong>Tài khoản đã bị đánh dấu xóa.</strong><br>
																<small>Dữ liệu vẫn được lưu trữ và có thể khôi phục bởi Root Admin.</small>
															</div>
														</div>
													</div>
												</li>
											</th:block>

											<!-- Sự kiện CẬP NHẬT GÌN NHẤT (nếu khác created) -->
											<th:block th:if="${user.updatedAt != null && user.deletedAt == null && !#temporals.format(user.updatedAt, 'yyyy-MM-dd HH:mm').equals(#temporals.format(user.createdAt, 'yyyy-MM-dd HH:mm'))}">
												<li class="time-label">
													<span class="bg-blue" th:text="${#temporals.format(user.updatedAt, 'dd/MM/yyyy')}">Ngày cập nhật</span>
												</li>
												<li>
													<i class="fa fa-edit bg-blue"></i>
													<div class="timeline-item">
														<span class="time"><i class="fa fa-clock-o"></i>
															<span th:text="${#temporals.format(user.updatedAt, 'HH:mm')}">14:30</span>
														</span>
														<h3 class="timeline-header">
															<strong>Cập nhật thông tin</strong>
														</h3>
														<div class="timeline-body">
															Thông tin tài khoản đã được cập nhật gần đây nhất.
														</div>
													</div>
												</li>
											</th:block>

											<!-- Sự kiện ĐĂNG NHẬP LẦN CUỐI (nếu có) -->
											<th:block th:if="${user.lastLogin != null}">
												<li class="time-label">
													<span class="bg-green" th:text="${#temporals.format(user.lastLogin, 'dd/MM/yyyy')}">Ngày đăng nhập</span>
												</li>
												<li>
													<i class="fa fa-sign-in bg-green"></i>
													<div class="timeline-item">
														<span class="time"><i class="fa fa-clock-o"></i>
															<span th:text="${#temporals.format(user.lastLogin, 'HH:mm')}">09:15</span>
														</span>
														<h3 class="timeline-header">Đăng nhập lần cuối</h3>
														<div class="timeline-body">
															Người dùng đã đăng nhập vào hệ thống.
														</div>
													</div>
												</li>
											</th:block>

											<!-- Sự kiện TRẠNG THÁI TÀI KHOẢN -->
											<li class="time-label">
												<span th:text="'Trạng thái hiện tại'">Trạng thái</span>
											</li>
											<li>
												<i class="fa"
												   th:classappend="${user.isActive ? 'fa-check-circle bg-green' : 'fa-lock bg-red'}"></i>
												<div class="timeline-item">
													<h3 class="timeline-header">
														<span th:if="${user.isActive}">
															<strong class="text-green">Tài khoản đang hoạt động</strong>
														</span>
														<span th:if="${!user.isActive}">
															<strong class="text-red">Tài khoản đã bị khóa</strong>
														</span>
													</h3>
													<div class="timeline-body">
														<div th:if="${user.isActive}">
															<span class="label label-success"><i class="fa fa-unlock"></i> Đang hoạt động bình thường</span>
															<span class="label label-info" th:if="${user.isVerified}">
																<i class="fa fa-certificate"></i> Đã xác thực email
															</span>
															<span class="label label-warning" th:if="${!user.isVerified}">
																<i class="fa fa-exclamation-triangle"></i> Chưa xác thực email
															</span>
														</div>
														<div th:if="${!user.isActive}" class="alert alert-warning" style="margin-top: 10px; margin-bottom: 0;">
															<i class="fa fa-lock"></i>
															<strong>Tài khoản bị khóa.</strong><br>
															<small>Người dùng không thể đăng nhập cho đến khi được kích hoạt lại.</small>
														</div>
													</div>
												</div>
											</li>

											<!-- Sự kiện TẠO TÀI KHOẢN -->
											<li class="time-label">
												<span th:text="${#temporals.format(user.createdAt, 'dd/MM/yyyy')}">Ngày tạo</span>
											</li>
											<li>
												<i class="fa fa-user-plus bg-aqua"></i>
												<div class="timeline-item">
													<span class="time"><i class="fa fa-clock-o"></i>
														<span th:text="${#temporals.format(user.createdAt, 'HH:mm')}">08:00</span>
													</span>
													<h3 class="timeline-header">
														<strong>Tạo tài khoản</strong>
													</h3>
													<div class="timeline-body">
														<p><i class="fa fa-user"></i> Tài khoản được tạo với vai trò:
															<span class="label"
																  th:classappend="${roleName == 'ADMIN' ? 'label-danger' : 'label-primary'}"
																  th:text="${roleName}">USER</span>
														</p>
														<p><i class="fa fa-id-card"></i> User ID: <code th:text="${user.userId}">user_id</code></p>
														<p><i class="fa fa-user-circle"></i> Username: <strong th:text="${user.username}">username</strong></p>
													</div>
												</div>
											</li>

											<!-- Kết thúc timeline -->
											<li>
												<i class="fa fa-clock-o bg-gray"></i>
											</li>
										</ul>
									</div>
									<p th:if="${user.createdAt == null}" class="text-muted">
										<i class="fa fa-info-circle"></i> Không có thông tin lịch sử hoạt động.
									</p>
								</div>
							</div>

							<div class="tab-pane" id="orders">
								<div class="box-body">
									<h4><i class="fa fa-shopping-bag"></i> Lịch sử đơn hàng</h4>
									<p class="text-muted">Chưa có dữ liệu đơn hàng.</p>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="row" th:if="${user == null}">
				<div class="col-md-12">
					<div class="box box-danger">
						<div class="box-header with-border">
							<h3 class="box-title">Lỗi</h3>
						</div>
						<div class="box-body">
							<p>Không tìm thấy người dùng với ID này.</p>
							<a th:href="@{/admin/users}" class="btn btn-primary">
								<i class="fa fa-arrow-left"></i> Quay lại danh sách
							</a>
						</div>
					</div>
				</div>
			</div>
		</section>
	</div>

	<div th:replace="~{admin/layout/footer :: footer}"></div>
</div>

<th:block th:replace="~{admin/layout/scripts :: scripts}"></th:block>
</body>
</html>